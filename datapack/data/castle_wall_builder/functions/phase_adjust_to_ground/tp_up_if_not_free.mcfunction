# Check an additional ring for towers
tag @e[type=minecraft:marker,tag=castle_wall_builder_not_free_marker,nbt={data:{type:"tower"}}] add castle_wall_builder_tower_not_free_marker
execute as @e[type=minecraft:marker,tag=castle_wall_builder_tower_not_free_marker] at @s if block ~-3 ~ ~-3 minecraft:air if block ~-3 ~ ~-2 minecraft:air if block ~-3 ~ ~-1 minecraft:air if block ~-3 ~ ~ minecraft:air if block ~-3 ~ ~1 minecraft:air if block ~-3 ~ ~2 minecraft:air if block ~-3 ~ ~3 minecraft:air if block ~-2 ~ ~3 minecraft:air if block ~-1 ~ ~3 minecraft:air if block ~ ~ ~3 minecraft:air if block ~1 ~ ~3 minecraft:air if block ~2 ~ ~3 minecraft:air if block ~3 ~ ~3 minecraft:air if block ~3 ~ ~2 minecraft:air if block ~3 ~ ~1 minecraft:air if block ~3 ~ ~ minecraft:air if block ~3 ~ ~-1 minecraft:air if block ~3 ~ ~-2 minecraft:air if block ~3 ~ ~-3 minecraft:air if block ~2 ~ ~-3 minecraft:air if block ~1 ~ ~-3 minecraft:air if block ~ ~ ~-3 minecraft:air if block ~-1 ~ ~-3 minecraft:air if block ~-2 ~ ~-3 minecraft:air run tag @s remove castle_wall_builder_tower_not_free_marker

# Checking all blocks in a 5x5 for air (and for towers only if the ring check succeeded)
execute as @e[type=minecraft:marker,tag=castle_wall_builder_not_free_marker,tag=!castle_wall_builder_tower_not_free_marker] at @s if block ~-2 ~ ~-2 minecraft:air if block ~-2 ~ ~-1 minecraft:air if block ~-2 ~ ~ minecraft:air if block ~-2 ~ ~1 minecraft:air if block ~-2 ~ ~2 minecraft:air if block ~-1 ~ ~-2 minecraft:air if block ~-1 ~ ~-1 minecraft:air if block ~-1 ~ ~ minecraft:air if block ~-1 ~ ~1 minecraft:air if block ~-1 ~ ~2 minecraft:air if block ~ ~ ~-2 minecraft:air if block ~ ~ ~-1 minecraft:air if block ~ ~ ~ minecraft:air if block ~ ~ ~1 minecraft:air if block ~ ~ ~2 minecraft:air if block ~1 ~ ~-2 minecraft:air if block ~1 ~ ~-1 minecraft:air if block ~1 ~ ~ minecraft:air if block ~1 ~ ~1 minecraft:air if block ~1 ~ ~2 minecraft:air if block ~2 ~ ~-2 minecraft:air if block ~2 ~ ~-1 minecraft:air if block ~2 ~ ~ minecraft:air if block ~2 ~ ~1 minecraft:air if block ~2 ~ ~2 minecraft:air run tag @s remove castle_wall_builder_not_free_marker

# TP 1 block up if not all blocks are air
execute as @e[type=minecraft:marker,tag=castle_wall_builder_not_free_marker] at @s run tp ~ ~1 ~
